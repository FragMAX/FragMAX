{% extends 'fragview/base.html' %}

{% block title %}FragMAX - Density viewer{% endblock %}
{% block content %}

<head>
  <meta name="viewport" content="width=device-width, user-scalable=no">
  <meta name="theme-color" content="#333333">
  <style>
    body {
      font-family: sans-serif;
      overflow: hidden
    }

    canvas {
      display: flex;
    }

    .side-table {
      font-size: 15px;
      line-height: 2px;
      margin-left: 9%;
      width: 80%
    }

    #viewer {
      position: absolute;
      left: 550px;
      width: calc(100% - 550px);
      height: 100%;
    }

    #help {
      display: none;
      font-size: 16px;
      color: #eee;
      background-color: rgba(0, 0, 0, 0.7);
      position: absolute;
      left: 550px;
      top: 50%;
      transform: translateY(-50%);
      cursor: default;
      padding: 5px;
      border-radius: 5px;
      z-index: 9;
      white-space: pre-line;
    }

    #left-controlpanel {
      font-size: 16px;
      background-color: rgba(0, 0, 0, 0.1);
      position: absolute;
      left: 265px;
      top: 10px;
      height: calc(100% - 20px);
      width: 270px;
      cursor: default;
      padding: 5px;
      border-radius: 5px;
      z-index: 9;
    }

    #hud u {
      text-decoration: none;
      border: solid;
      border-width: 1px 0;
    }

    #hud s {
      padding: 0 8px;
      text-decoration: none;
      opacity: 0.5;
    }

    #inset {
      width: 200px;
      height: 200px;
      background-color: #888;
      position: absolute;
      right: 0;
      bottom: 0;
      z-index: 2;
      display: none;
    }

    a {
      color: #59C;
    }

    .svg {
      -webkit-filter: contrast(0.5);
      filter: contrast(0.5);
    }

    .ligandSVG {
      position: absolute;
      bottom: 0px;
      width: 250px;
      font-size: 22px;
      font-weight: bold;
    }

    button.link {
      font-family: "Verdana"sans-serif;
      font-size: 1.1em;
      text-align: left;
      color: #039be5;
      background: none;
      margin: 0;
      padding: 0;
      border: none;
      cursor: pointer;
    }

    .navbt {
      width: 110px;
      font-size: 11px;
    }

    .navbt {
      width: 110px;
      font-size: 11px;
    }

    .navbt2 {
      width: 170px;
      font-size: 11px;
    }
  </style>

  <script src="/static/libs/uglymol.js"></script>
  <script src="/static/libs/wasm/mtz.js"></script>

</head>

<body style="background-color: white">



  <div id="left-controlpanel">
    {% comment %} <div style="padding-left:30px !important;">
      <div>
        <h6>Blob navigation</h6>
      </div>
    </div>
    <div style="padding-left:30px !important;">

      <input class="btn " type="button" value="Previous" onclick="return previousblob()"></input>
      <input class="btn" type="button" value="Next" onclick="return nextblob()"></input>
    </div> {% endcomment %}
    <div style="padding-left:30px !important;">
      <div>
        <h6>Structure navigation</h6>
      </div>
      <div style="display:inline-flex">
        <form action="/pipedream_density/" method="get">
          <button class="btn" type="submit" value="{{prevstr}}" name="structure">Previous</button>
        </form>
        <form action="/pipedream_density/" method="get" style="padding-left: 5px;">
          <button class="btn" type="submit" value="{{nextstr}}" name="structure">Next</button>
        </form>
      </div>
    </div>
    <div style="padding-top:20px">
      <table class="side-table">
        <tr>
          <th>Resolution
          </th>
          <td>{{resolution}} Ã…
          </td>
        </tr>
        <tr>
          <th>Rwork
          </th>
          <td>{{rwork}}
          </td>
        </tr>
        <tr>
          <th>Rfree
          </th>
          <td>{{rfree}}
          </td>
        </tr>
        <tr>
          <th>RhoFit score
          </th>
          <td>{{rhofitscore}}
          </td>
        </tr>

        <tr>
          <th>Spacegroup
          </th>
          <td>{{symmetry}}
          </td>
        </tr>



        <tr>
          {% if ligand %}

          <td colspan="2"><b>Download</b>
            <a href="{{pdb}}" download="{{name}}.pdb" style="padding-left: 10px;"> PDB</a> |
            <a href="{{mtz}}" download="{{name}}.mtz"> MTZ</a> |
            <a href="/static/biomax/{{project.proposal}}/{{project.shift}}/fragmax/fragments/{{ligand}}.cif"
              download="{{ligand}}.cif"> CIF</a></td>
          {% else %}

          <th>Download</th>
          <td><a href="{{pdb}}" download="{{name}}.pdb"> PDB</a> |
            <a href="{{mtz}}" download="{{name}}.mtz"> MTZ</a> </td>
          {% endif %}
        </tr>
        <tr style="border-bottom: 0;">
          <th>
            <p>Logs</p>
            <form action="/log_viewer/" method="get" id="logFileform" target="_blank" style="height: 10px;">
              <button class="link" type="submit"
                value="{{project.data_path}}/fragmax/results/{{prefix}}/pipedream/summary.out" name="logFile"
                size="1">Pipedream</button>
            </form>

            <form action="/log_viewer/" method="get" id="logFileform" target="_blank" style="height: 10px;">
              <button class="link" type="submit"
                value="{{project.data_path}}/fragmax/results/{{prefix}}/pipedream/process.out" name="logFile"
                size="1">autoPROC</button>
            </form>
            <form action="/log_viewer/" method="get" id="logFileform" target="_blank" style="height: 10px;">
              <button class="link" type="submit"
                value="{{project.data_path}}/fragmax/results/{{prefix}}/pipedream/refine.out" name="logFile"
                size="1">BUSTER</button>
            </form>
            <form action="/log_viewer/" method="get" id="logFileform" target="_blank" style="height: 10px;">
              <button class="link" type="submit"
                value="{{project.data_path}}/fragmax/results/{{prefix}}/pipedream/rhofit-{{ligand}}.out" name="logFile"
                size="1">RhoFit</button>
            </form>
          </th>

        </tr>

      </table>
    </div>

    {% if ligand %}
    <div class="ligandSVG">
      <div>
        <p style="text-align: center;">{{ligand}}</p>
      </div>
      <img class="ligpng ligandSVG svg" id="ligand" src="/fragment/{{ligand}}/image">
    </div>
    {% endif %}
  </div>
  </div>
  <div style="display:flex;">
    <div style="z-index:1; color: #FCFCFC; position: absolute; bottom: 20px; left: 600px">
      <b>
        <h6>{{name }} </h6>
      </b>
      <b>
        <h6>Pipedream</h6>
      </b>
      <header id="hud">Electron density viewer. Press H for help.</header>
    </div>
  </div>


  <div id="viewer"></div>

  <footer id="help"></footer>
  <div id="inset"></div>

  <script>
    V = new UM.Viewer({
      viewer: "viewer",
      hud: "hud",
      help: "help"
    });
    V.load_pdb("{{pdb}}", null, function () {
      this.V.model_bags[V.model_bags.length - 1].label = "protein"
    })
    GemmiMtz().then(function (Module) {
      UM.load_maps_from_mtz(Module, V, "{{mtz}}");
    });

    V.load_pdb("{{rhofit}}", null, function () {
      this.V.model_bags[V.model_bags.length - 1].label = "rhofit"
    });



    function showrhofit() {
      var rpos = search("rhofit", V.model_bags)
      V.model_bags[rpos].visible ^= true;
      V.redraw_all()
      V.request_render();
    }

    function centerrhofit() {
      V.recenter(V.model_bags[search("rhofit", V.model_bags)].atom_array[0].xyz, null, 25)
      V.request_render();
    }


    $(document).ready(function () {
      $(document).bind("keydown", function (e) {
        e = e || window.event;
        var charCode = e.which || e.keyCode;
        if (charCode == 88) centerrhofit();
      });
    });

    function search(nameKey, myArray) {
      for (var i = 0; i < myArray.length; i++) {
        if (myArray[i].label === nameKey) {
          return i;
        }
      }
    }
    $(document).on('click', '#ligand', function () {
      V.recenter(V.model_bags[search("rhofit", V.model_bags)].atom_array[0].xyz, null, 25)
      V.request_render();
    });
  </script>
</body>

</html>


{% endblock %}