{% extends 'fragview/base.html' %}

{% load static %}
{% block title %}FragMAX - Dataset info{% endblock %}
{% block content %}
<meta name="viewport" content="width=device-width, user-scalable=no">
<meta name="theme-color" content="#333333">

<style>
    td, th {
        padding: 5px 5px;
        display: table-cell;
        text-align: left;
        vertical-align: middle;
        border-radius: 2px;
        font-size: 12px;

    }
    #resultsTable th {
      cursor: pointer;
    }
    .resultsHeader{
        text-align: center; 
        font-size:16px;
    }
    .top-options {
        font-size: 15px !important;
    }
    .content {
        margin: auto !important;
        max-width: 100% !important;
        width: 100% !important;
    }
    .card-content-left{
        padding: 24px 24px 38px 24px !important;
    }
    .card-content-right{
        padding: 24px 24px 28px 24px !important;
    }
    .card_options {
        padding-left: 310px  !important;

        max-width: calc(100% - 50px)  !important;
        {% comment %} max-width: 2455px  !important;
        min-width: 1800px; {% endcomment %}
    }
    .flexdiv {
        display: flex;
        padding-left: 300px;
        max-width: calc(100% - 50px)  !important;

        {% comment %} max-width: 2455px !important; {% endcomment %}
    }
    .flexdiv_options {
        display: flex;
        {% comment %} padding-left: 40px; {% endcomment %}
    }
    .flex-left {
        max-width:750px; 
        width: 33%
    }
    .flex-right {
        margin-left:10px;    
        max-width:750px; 
        width: 33%
    }    
    .flex-center {
        margin-left:10px; 
        max-width:750px;     
        width: 33%
    }


    .crystalsnap {
        max-width: 400px;
        padding: 10px;
    }
    .diffimg {
        max-width: 100%;
        height: auto;
        width: auto\9; /* ie8 */
        }
    .diffsnap{
        max-width:400px;
        padding:10px;
    }
    .flexdiv_snapshot {
        display: flex;
    }

    #snaps {
    width: 800px;
    height: 800px;
    margin: 0 auto;
    }

    #snaps > img {
    float: left;
    width: 45%;
    margin: 1.66%;
    }

    .selectbox {
        display: flex !important; 
    }
    .optionstable {
        border-collapse: separate;
        border-spacing: 0;
    }
    .tableSoak {
        border-collapse: separate;
        border-spacing: 0;
        width: 100% !important;

    }
    .tableInfo {
        width: 100% !important;
    }
    
    .bottom-right    {
        right: 30;
        bottom: 20;
        position: absolute;        
    }
    .btn-right {
        float:right !important;
    }
    .maxivorange {
        background-color: #fea901;
    }
    .custompar {
        background-color: #f0f0f0;
    }
    .ligpng {
        height: 95px;
    }
    .card-title {
        display:inline-flex !important;
    }
    button.link {
	font-family: "Verdana" sans-serif;
	font-size: 1.1em;
	text-align: left;
	color: #039be5;
	background: none;
	margin: 0;
	padding: 0;
	border: none;
	cursor: pointer;
    }
    .logtab{
        padding-bottom: 20px;
    }
</style>

<style>
    .myImg {
        cursor: pointer;}

    /* The Modal (background) */
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        padding-top: 100px; /* Location of the box */
        max-height: 100%;
        left: 250px;
        top: 0;
        width: calc(100% - 200px); /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgb(0,0,0); /* Fallback color */
        background-color: rgba(0,0,0,0.7); /* Black w/ opacity */
    }

    /* Modal Content (image) */
        .modal-content {
        margin: auto;
        display: block;
        max-height: 960px;
    }


    /* Style the tab */
    .tab {
        overflow: hidden;

        background-color: #f1f1f1;
    }

    /* Style the buttons inside the tab */
    .tab button {
        background-color: inherit;
        float: left;
        border: none;
        outline: none;
        cursor: pointer;
        padding: 14px 16px;
        transition: 0.3s;
        font-size: 17px;
    }



    /* Create an active/current tablink class */
    .tab button.active {
        background-color: #fea901;
    }

    /* Style the tab content */
    .tabcontent {
        display: none;
        padding: 6px 12px;
    }
</style>


<body >

<div >
    <h5 style="padding-left:310px;" > {{imgprf}}_{{run}} Dataset information </h5>
    {{new_proc_run | safe}}
    <div style="display:flex; padding-left:310px; ">
        <h6 >Open processing report</h6>
        
        {% if dialsOK == "ready" %}
        <form action="/procReport/" method="get"  size="1" style="padding-left:20px; " target="_blank">
            <button class="btn-small" type="submit" value="{{dialsreport}}" name="dataHeader" size="1">DIALS</button>
        </form>
        {% endif %}
        {% if xdsOK == "ready" %}
        <form action="/procReport/" method="get"  size="1" style="padding-left:20px; " target="_blank">
            <button class="btn-small" type="submit" value="{{xdsreport}}" name="dataHeader" size="1">XDS/XSCALE</button>
        </form>        
        {% endif %}
        {% if autoprocOK == "ready" %}
        <form action="/procReport/" method="get"  size="1" style="padding-left:20px; " target="_blank">
            <button class="btn-small" type="submit" value="{{autoprocreport}}" name="dataHeader" size="1">autoPROC</button>
        </form>
        {% endif %}
        {% if xdsappOK == "ready" %}
        <form action="/log_viewer/" method="get" id="logFileform" style="padding-left:20px; " target="_blank">
            <button class="btn-small" type="submit" value="{{xdsappreport}}" name="logFile" size="1" >XDSAPP</button>
        </form>
        {% endif %}
        {% if fastdpOK == "ready" %}
        <form action="/log_viewer/" method="get" id="logFileform" style="padding-left:20px; " target="_blank">
            <button class="btn-small" type="submit" value="{{fastdpreport}}" name="logFile" size="1" >Fastdp</button>
        </form>
        {% endif %}
        {% if ednaOK == "ready" %}
        <form action="/log_viewer/" method="get" id="logFileform" style="padding-left:20px; " target="_blank">
            <button class="btn-small" type="submit" value="{{ednareport}}" name="logFile" size="1" >EDNA</button>
        </form>
        {% endif %}
    </div>
</div>


<!-- The Modal -->
<div id="myModal" class="modal">
    <span class="close">&times;</span>
    <img class="modal-content" id="img01">
    <div id="caption"></div>
</div>
<div class="card_options">
    <div class=" card " style="min-width:925px">
        <div >
            <div>
                <div class="card-content card-content-left">
                    <div class="card-title">Results</div>
                    <table class="optionstable"  id="resultsTable"> 
                        <thead>
                            <tr>
                            <th class="resultsHeader">View Structure</th>
                            <th class="resultsHeader">Data set</th>
                            <th class="resultsHeader">Space group</th>
                            <th class="resultsHeader">Res. [&Aring;]</th>
                            <th class="resultsHeader">R<sub>work</sub> [%]</th>
                            <th class="resultsHeader">R<sub>free</sub> [%]</th>
                            <th class="resultsHeader">RMS bonds [&Aring;]</th>
                            <th class="resultsHeader">RMS angles [&deg;]</th>
                            <th class="resultsHeader">a</th>
                            <th class="resultsHeader">b</th>
                            <th class="resultsHeader">c</th>
                            <th class="resultsHeader">&alpha;</th>
                            <th class="resultsHeader">&beta;</th>
                            <th class="resultsHeader">&gamma;</th>
                            <th class="resultsHeader">RhoFit</th>
                            <th class="resultsHeader">LigFit</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>    
                            </tr>
                            {% for usracr,pdbout,dif_map,nat_map,spg,resolution,isa,r_work,r_free,bonds,angles,a,b,c,alpha,beta,gamma,blist,dataset,pipeline,rhofitscore,ligfitscore,ligblob in csvfile %}

                            <tr>    
                            <td style="text-align:center;padding-top: 10px;">
                                <form action="/density/" method="get" target="_blank">
                                <button class="btn" type="submit" 
                                value="{{usracr}}" 
                                name="structure" >Open</button>
                                </form>
                            </td>
                            <td >{{usracr}}</td>
                            <td style="text-align:center">{{spg}}</td>
                            <td style="text-align:center">{{resolution}}</td>
                            <td style="text-align:center">{{r_work}}</td>
                            <td style="text-align:center">{{r_free}}</td>
                            <td style="text-align:center">{{bonds}}</td>
                            <td class="rms" style="text-align:center">{{angles}}</td>
                            <td style="text-align:center">{{a}}</td>
                            <td style="text-align:center">{{b}}</td>
                            <td style="text-align:center">{{c}}</td>
                            <td style="text-align:center">{{alpha}}</td>
                            <td style="text-align:center">{{beta}}</td>
                            <td style="text-align:center">{{gamma}}</td>
                            <td style="text-align:center">{{rhofitscore}}</td>
                            <td style="text-align:center">{{ligfitscore}}</td>
                            
                            </tr>
                            {% endfor %}                   
                                    
                        </tbody>

                </table>
            </div>

        </div>
    </div>
</div>
</div>
        


<div class="flexdiv">
    <div id="snaps">
                {% if dialsOK == "ready" %}
                    <form action="/reciprocal_lattice/{{imgprf}}/{{run}}"
                          method="get" size="1" style="padding-left:25%;"
                          target="_blank">
                        <button class="btn-large" type="submit" size="1">Open Reciprocal Lattice Viewer</button>
                    </form>
                {% endif %}

                <img class="myImg diffsnap" id="diff1" src="/diffraction/{{imgprf}}/{{run}}/1">
                <img class="myImg diffsnap" id="diff2" src="/diffraction/{{imgprf}}/{{run}}/{{diffraction_half}}">
        
                <img class="myImg crystalsnap" id="snap1" src="{{snapshots.0}}"
                     onerror="if (this.src != '/static/img/nosnap.png') this.src='/static/img/nosnap.png';">
                <img class="myImg crystalsnap" id="snap2" src="{{snapshots.1}}"
                     onerror="if (this.src != '/static/img/nosnap.png') this.src='/static/img/nosnap.png';">
        
        
    </div>
    <div class="flex-left">
        <div class="card" style="min-height:700px">
            <div class="card-content card-content-left">
                <div class="card-title">Experiment parameters</div>
                <table class="tableInfo">
                    <col width="200">
                    <col width="450">
                    <tbody>
                        <tr>
                            <th>Img directory</th>
                            <td name="imgdirNAME" id="imgdirID">
                                <p style="word-break: break-all;">
                                    {{xsdata.imageDirectory}}
                                </p>
                            </td>
                        </tr>
                        <tr>
                            <th>Img prefix</th>
                            <td>{{project.protein}}</td>
                        </tr>
                        <tr>
                            <th>Run number</th>
                            <td>{{run}}</td>
                        </tr>
                        <tr>
                            <th># of images</th>
                            <td>{{xsdata.numberOfImages}}</td>
                        </tr>
                        <tr>
                            <th>Start time</th>
                            <td>{{xsdata.startTime}} </td>
                        </tr>
                        <tr>
                            <th>End time</th>
                            <td>{{xsdata.endTime}}</td>
                        </tr>
                        <tr>
                            <th>Type of experiment</th>
                            <td>OSC</td>
                        </tr>
                        <tr>
                            <th>Wavelength</th>
                            <td>{{xsdata.wavelength|floatformat:6}} Å</td>
                        </tr>
                        <tr>
                            <th>Energy</th>
                            <td>{{energy}} keV</td>
                        </tr>
                        <tr>
                            <th>Phi Start</th>
                            <td>{{xsdata.axisStart}}°</td>
                        </tr>
                        <tr>
                            <th>Oscillation range</th>
                            <td>{{xsdata.axisRange}}°</td>
                        </tr>
                        <tr>
                            <th>Overlap</th>
                            <td>{{xsdata.overlap|floatformat:1}}°</td>
                        </tr>
                        <tr>
                            <th>Exposure time</th>
                            <td>{{xsdata.exposureTime|floatformat:3}} s</td>
                        </tr>
                        <tr>
                            <th>Total Exposure time</th>
                            <td>{{totalExposure}} s</td>
                        </tr>
                        <tr>
                            <th>Estimated dose</th>
                            <td>Not defined</td>
                        </tr>
                        <tr>
                            <th>Detector distance</th>
                            <td>{{xsdata.detectorDistance|floatformat:2}} mm</td>
                        </tr>
                        <tr>
                            <th>Resolution at edge</th>
                            <td>{{xsdata.resolution|floatformat:2}} Å</td>
                        </tr>
                        <tr>
                            <th>Resolution at corner</th>
                            <td>{{edgeResolution}} Å</td>
                        </tr>
                        <tr>
                            <th>Xbeam</th>
                            <td>{{xsdata.xbeam}} mm</td>
                        </tr>
                        <tr>
                            <th>Ybeam</th>
                            <td>{{xsdata.ybeam}} mm</td>
                        </tr>
                        <tr>
                            <th>Kappa</th>
                            <td>0</td>
                        </tr>
                        <tr>
                            <th>Phi</th>
                            <td>0</td>
                        </tr>

                    </tbody>

                </table>
            </div>

        </div>
    </div>

    <div class="flex-right">
        <div class="card" style="min-height:700px">
            <div class="card-content card-content-right">
                <div class="card-title">Beamline parameters</div>
                <table class="tableInfo">
                    <col width="200">
                    <col width="450">
                    <tbody>
                        <tr>
                            <th>Synchrotron</td>
                            <td>{{BL_site}}</td>
                        </tr>
                        <tr>
                            <th>Filling mode</td>
                            <td>{{xsdata.synchrotronMode}}</td>
                        </tr>
                        <tr>
                            <th>Beamline</td>
                            <td>{{BL_name}}</td>
                        </tr>                        
                        <tr>
                            <th>Detector type</td>
                            <td>{{BL_detector_type}}</td>
                        </tr>
                        <tr>
                            <th>Detector model</td>
                            <td>{{BL_detector}}</td>
                        </tr>
                        <tr>
                            <th>Detector pixel size (HxV)</td>
                            <td>{{BL_detector_pixel_size}}</td>
                        </tr>
                        <tr>
                            <th>Focusing optics</td>
                            <td>{{BL_focusing_optics}}</td>
                        </tr>
                        <tr>
                            <th>Monochromator type</td>
                            <td>{{BL_monochrom_type}}</td>
                        </tr>
                        <tr>
                            <th>Beam shape</td>
                            <td>{{xsdata.beamShape}}</td>
                        </tr>
                        <tr>
                            <th>Beam transmission</td>
                            <td>{{xsdata.transmission|floatformat:3}}%</td>
                        </tr>
                        <tr>
                            <th>Slit gap hor</td>
                            <td>{{xsdata.slitGapHorizontal|floatformat:1}} μm</td>
                        </tr>
                        <tr>
                            <th>Slit gap ver</td>
                            <td>{{xsdata.slitGapVertical|floatformat:1}} μm</td>
                        </tr>
                        <tr>
                            <th>Flux (estimated)</td>
                            <td>{{xsdata.flux|stringformat:".3e" }} ph/s</td>
                        </tr>
                        <tr>
                            <th>Beam size at sample (HxV)</td>
                            <td>{{xsdata.beamSizeSampleX}} μm x {{xsdata.beamSizeSampleY}} μm</td>
                        </tr>
                        <tr>
                            <th>Beam divergence (HxV)</td>
                            <td>{{BL_beam_divergence}}</td>
                        </tr>
                        <tr>
                            <th>Polarisation</td>
                            <td>{{BL_polarisation}}</td>
                        </tr>
                    </tbody>
                </table>
                <br>
                <div class="card-title">Soaking parameters</div>
                <table class="tableSoak">
                    <col width="320">
                    <col width="300">
                    <col width="450">
                    <tbody>
                        <tr>
                            <th>Soaking time</td>
                            <td>{{soakTime}} </td>
                            <td rowspan="3" >
                                <img class="ligpng"
                                     id="ligand"
                                     src="/fragment/{{ligand}}/image"
                                     onerror="if (this.src != '/static/img/nolig.png') this.src='/static/img/nolig.png';">
                            </td>
                        </tr>
                        <tr>
                            <th>Fragment Concentration</th>
                            <td>{{fragConc}}</td>
                            <td></td>
                        </tr>
                        <tr>
                            <th>DMSO Concentration (final)</th>
                            <td>{{solventConc}}</td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<h5 style="padding-left:310px;">Advanced log viewer</h5>

<div class=" card_options">
    <div class="card tab">
        <button class="tablinks" onclick="openMethod(event, 'EDNA')">EDNA_proc</button>
        <button class="tablinks" onclick="openMethod(event, 'fastdp')">FastDP</button>
        <button class="tablinks" onclick="openMethod(event, 'DIALS')">DIALS</button>
        <button class="tablinks" onclick="openMethod(event, 'XDS_XSCALE')">XDS/XSCALE</button>
        <button class="tablinks" onclick="openMethod(event, 'XDSAPP')">XDSAPP</button>
        <button class="tablinks" onclick="openMethod(event, 'autoPROC')">autoPROC</button>
<!--        <button class="tablinks" onclick="openMethod(event, 'DIMPLE')">DIMPLE</button>
        <button class="tablinks" onclick="openMethod(event, 'BUSTER')">BUSTER</button>
        <button class="tablinks" onclick="openMethod(event, 'FSPipeline')">FSPipeline</button>
        <button class="tablinks" onclick="openMethod(event, 'RhoFit')">RhoFit</button>
        <button class="tablinks" onclick="openMethod(event, 'LigFit')">LigandFit</button>
        <button class="tablinks" onclick="openMethod(event, 'Pipedream')">Pipedream</button>-->
        <button class="tablinks" onclick="openMethod(event, 'Hide')">Hide</button>


    </div>
    <div id="EDNA" class="card tabcontent ">
        <div class="card-title logtab">EDNA_proc Logs</div>
        {% if ednaOK == "ready" %}
        {% for logName,logPath in ednaLogs %}
        <form action="/log_viewer/" method="get" id="logFileform" style="padding-left:20px; " target="_blank">
            <button class="link" type="submit" value="{{logPath}}" name="logFile" size="1" >{{logName}}</button>
        </form>
        {% endfor %}
        {% endif %}
    </div>
    <div id="fastdp" class="card tabcontent ">
        <div class="card-title logtab">FastDP Logs</div>
        {% if fastdpOK == "ready" %}
        {% for logName,logPath in fastdpLogs %}
        <form action="/log_viewer/" method="get" id="logFileform" style="padding-left:20px; " target="_blank">
            <button class="link" type="submit" value="{{logPath}}" name="logFile" size="1" >{{logName}}</button>
        </form>
        {% endfor %}
        {% endif %}
    </div>
    <div id="DIALS" class="card tabcontent ">
        <div class="card-title logtab">XIA2/Dials Logs</div>
        {% if dialsOK == "ready" %}
        {% for logName,logPath in dialsLogs %}
        <form action="/log_viewer/" method="get" id="logFileform" style="padding-left:20px; " target="_blank">
            <button class="link" type="submit" value="{{logPath}}" name="logFile" size="1" >{{logName}}</button>
        </form>
        {% endfor %}
        {% endif %}
    </div>
    <div id="XDS_XSCALE" class="card tabcontent ">
        <div class="card-title logtab">XIA2/XDS_xscale Logs</div>
        {% if xdsOK == "ready" %}
        {% for logName,logPath in xdsLogs %}
        <form action="/log_viewer/" method="get" id="logFileform" style="padding-left:20px; " target="_blank">
            <button class="link" type="submit" value="{{logPath}}" name="logFile" size="1" >{{logName}}</button>
        </form>
        {% endfor %}
        {% endif %}
    </div>
    <div id="XDSAPP" class="card tabcontent ">
        <div class="card-title logtab">XDSAPP Logs</div>
        {% if xdsappOK == "ready" %}
        {% for logName,logPath in xdsappLogs %}
        <form action="/log_viewer/" method="get" id="logFileform" style="padding-left:20px; " target="_blank">
            <button class="link" type="submit" value="{{logPath}}" name="logFile" size="1" >{{logName}}</button>
        </form>
        {% endfor %}
        {% endif %}
    </div>
    <div id="autoPROC" class="card tabcontent ">
        <div class="card-title logtab">autoPROC Logs</div>
        {% if autoprocOK == "ready" %}
        {% for logName,logPath in autoprocLogs %}
        <form action="/log_viewer/" method="get" id="logFileform" style="padding-left:20px; " target="_blank">
            <button class="link" type="submit" value="{{logPath}}" name="logFile" size="1" >{{logName}}</button>
        </form>
        {% endfor %}
        {% endif %}
    </div>
<!--    <div id="DIMPLE" class="card tabcontent">
        <div class="card-title">DIMPLE Logs</div>
        <p>file 1</p>
        <p>file 2</p>
    </div>
    <div id="BUSTER" class="card tabcontent">
        <div class="card-title">BUSTER Logs</div>
        <p>file 1</p>
        <p>file 2</p>
    </div>
    <div id="FSPipeline" class="card tabcontent">
        <div class="card-title">FSpipeline Logs</div>
        <p>file 1</p>
        <p>file 2</p>
    </div>
    <div id="RhoFit" class="card tabcontent">
        <div class="card-title">RhoFit Logs</div>
        <p>file 1</p>
        <p>file 2</p>
    </div>
    <div id="LigFit" class="card tabcontent">
        <div class="card-title">LigandFit Logs</div>
        <p>file 1</p>
        <p>file 2</p>
    </div>
    <div id="Pipedream" class="card tabcontent">
        <div class="card-title">Pipedream Logs</div>
        <p>file 1</p>
        <p>file 2</p>
    </div>-->

</div>

</body>

<script>
    
    // Get the modal
    var modal = document.getElementById('myModal');

    // Get the image and insert it inside the modal - use its "alt" text as a caption
    var img = document.getElementById('diff1');
    var img2 = document.getElementById('diff2');
    var img3 = document.getElementById('snap1');
    var img4 = document.getElementById('snap2');

    var modalImg = document.getElementById("img01");

    img.onclick = function () {
        modal.style.display = "block";
        modalImg.src = this.src;
        captionText.innerHTML = this.alt;
    }
    img2.onclick = function () {
        modal.style.display = "block";
        modalImg.src = this.src;
        captionText.innerHTML = this.alt;
    }
    img3.onclick = function () {
        modal.style.display = "block";
        modalImg.src = this.src;
        captionText.innerHTML = this.alt;
    }
    img4.onclick = function () {
        modal.style.display = "block";
        modalImg.src = this.src;
        captionText.innerHTML = this.alt;
    }
    window.onclick = function (event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    const getCellValue = (tr, idx) => tr.children[idx].innerText || tr.children[idx].textContent;

    const comparer = (idx, asc) => (a, b) => ((v1, v2) => 
        v1 !== '' && v2 !== '' && !isNaN(v1) && !isNaN(v2) ? v1 - v2 : v1.toString().localeCompare(v2)
        )(getCellValue(asc ? a : b, idx), getCellValue(asc ? b : a, idx));

    // do the work...
    document.querySelectorAll('th').forEach(th => th.addEventListener('click', (() => {
        const table = th.closest('table');
        Array.from(table.querySelectorAll('tr:nth-child(n+2)'))
            .sort(comparer(Array.from(th.parentNode.children).indexOf(th), this.asc = !this.asc))
            .forEach(tr => table.appendChild(tr) );
    })));
    
</script>


<script>
    function openMethod(evt, methodName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(methodName).style.display = "block";
        evt.currentTarget.className += " active";
    }
</script>


{% endblock %}