{% extends 'fragview/base.html' %}

{% load static %}

{% block content %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

<style>
    td, th {
        padding: 5px 5px;
        display: table-cell;
        text-align: left;
        vertical-align: middle;
        border-radius: 2px;
        font-size: 12px;
    }
    .top-options {
        font-size: 15px !important;
    }
    .content {
        margin: auto !important;
        max-width: 100% !important;
        width: 100% !important;
    }
    .card-content-left{
        padding: 24px 24px 38px 24px !important;
    }
    .card-content-right{
        padding: 24px 24px 28px 24px !important;
    }
    .card_options {
        padding-left: 260px  !important;
        max-width: 2455px  !important;
    }
    .flexdiv {
        display: flex;
        padding-left: 250px;
        max-width: 2455px !important;
    }
    .flexdiv_options {
        display: flex;
        padding-left: 40px;
    }
    .flex-left {
        flex-basis: 1;
        max-width:750px; 
    }
    .flex-right {
        margin-left:10px;    
        max-width:750px; 
    }    
    .flex-center {
        margin-left:10px;     
    }
    .crystalsnap {
        width: 400px;
        padding: 10px;
    }
    .flexdiv_snapshot {
        display: flex;
    }
    .selectbox {
        display: flex !important; 
    }
    .optionstable {
        border-collapse: separate;
        border-spacing: 0;
    }
    .tableSoak {
        border-collapse: separate;
        border-spacing: 0;
        width: 100% !important;

    }
    .tableInfo {
        width: 100% !important;
    }
    
    .bottom-right    {
        right: 30;
        bottom: 20;
        position: absolute;        
    }
    .btn-right {
        float:right !important;
    }
    .maxivorange {
        background-color: #fea901;
    }
    .custompar {
        background-color: #f0f0f0;
    }
    .ligpng {
        height: 95px;
    }
    .card-title {
        display:inline-flex !important;
    }
</style>

<style>
    .myImg {
        cursor: pointer;}

    /* The Modal (background) */
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        padding-top: 100px; /* Location of the box */
        max-height: 100%;
        left: 200px;
        top: 0;
        width: calc(100% - 200px); /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgb(0,0,0); /* Fallback color */
        background-color: rgba(0,0,0,0.7); /* Black w/ opacity */
    }

    /* Modal Content (image) */
        .modal-content {
        margin: auto;
        display: block;
        max-height: 960px;
    }
</style>


<div >
    <h5 style="padding-left:260px;" > {{imgprf}}_{{run}} Dataset information </h5>
{% comment %}<form style="padding-left:260px;" action="/procReport/" method="get" id="dialsreport">
    <input type="hidden" value="dials{{imgprf}}" name="dataHeader2" size="1">
    <a href="javascript:{}" onclick="document.getElementById('dialsreport').submit();"><h6 >Open DIALS processing report</h6></a></form> {% endcomment %}
    {{new_proc_run | safe}}
    <div style="display:flex; padding-left:260px; ">
        <h6 >Open processing report</h6>
        <form action="/procReport/" method="get" name="dialsreport2" size="1" style="padding-left:20px; ">
            <button class="btn-small" type="submit" value="dials{{imgprf}}" name="dataHeader" size="1">DIALS</button>
        </form>
        <form action="/procReport/" method="get" name="dialsreport2" size="1" style="padding-left:20px; ">
            <button class="btn-small" type="submit" value="autoPROC{{imgprf}}" name="dataHeader" size="1">autoPROC</button>
        </form>

    </div>
</div>


<!-- The Modal -->
<div id="myModal" class="modal">
    <span class="close">&times;</span>
    <img class="modal-content" id="img01">
    <div id="caption"></div>
</div>

<div class="card_options">
    <div class="flexdiv_options card ">
        <div class="flex-left">
            <div>
                <div class="card-content card-content-left">
                    <div class="card-title">Data processing</div>
                    <table class="optionstable" > 
                        <col width="200">
                        <col width="450">
                        <tbody>
                            <tr>
                                <th class="top-options">Software</th>
                                <td class=" top-options">
                                    <select class="selectbox" name="procSW">
                                        <option disabled selected value> -- select an option -- </option>
                                        <option value="dials">XIA2/DIALS</option>
                                        <option value="xdsxscale">XIA2/XDS_XSCALE</option>
                                        <option value="autoproc">autoProc</option>
                                        <option value="xdsapp">XDSAPP</option>
                                    </select>                
                                </td>
                            </tr>
                <tr>
                    <th class=" top-options">Space group</th>
                    <td class=" top-options">
                        <input class="selectbox" name="spacegroup" placeholder="P43212"></input>
                    </td>
                </tr>

                <tr>
                    <th class=" top-options">Cell parameters</th>
                    <td class=" top-options"><input class="selectbox" name="cellparameters" placeholder="(a, b, c, α, β, γ)"></input> </td>
                </tr>
                <tr>
                    <th class=" top-options">Friedel law</th>
                    <td class=" top-options">
                        <select class="selectbox" name="friedel">
                            <option disabled selected value> -- select an option -- </option>
                            <option value="friedeltrue">True</option>
                            <option value="friedelfalse">False</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <th class=" top-options">Data range</th>
                    <td class=" top-options"><input class="selectbox" name="datarange" placeholder="e.g.:  1-1800"></input> </td>
                </tr>
                <tr>
                    <th class=" top-options">Resolution cutoff</th>
                    <td class=" top-options"><input class="selectbox" name="rescutoff" placeholder="default: None"></input> </td>
                </tr>
                <tr>
                    <th class=" top-options">CC1/2 cutoff</th>
                    <td class=" top-options"><input class="selectbox" name="cccutoff" placeholder="default: None"></input> </td>
                </tr>
                <tr>
                    <th class=" top-options">I/σ(I) cutoff</th>
                    <td class=" top-options"><input class="selectbox" name="isigmacutoff" placeholder="default: None"></input> </td>
                </tr>
                <tr class="custompar">
                    <th class=" top-options">Custom parameters</th>
                    <td class=" top-options"><input class="selectbox" name="customdataproc" placeholder="default: None"></input> </td>
                </tr>
                <tr>
                    <th></th>
                    <td style="padding-top:20px">
                         <form action="/reproc_web/" method="get" id="procB" name="dataprocButton" size="1" style="padding-left:20px;" target="_blank">
                            <button class="btn btn-right" type="submit" onsubmit="return dataproc()" value="No Software Selected" name="submitProc" size="1">Run data processing</button>
                        </form>


                    </td>
                </tr>

                </tbody>

                </table>
            </div>

        </div>
    </div>

    <div class="flex-center">
        <div>

            <div class="card-content card-content-left">
                <div class="card-title">Structure Refinement</div>
                <table class="optionstable">
                    <col width="200">
                    <col width="450">
                    <tbody>
                        <tr>
                            <th class=" top-options">Software</th>
                            <td class=" top-options">
                                <select class="selectbox" name="refinSW">
                                    <option disabled selected value> -- select an option -- </option>
                                    <option value="dimple">Dimple</option>
                                    <option value="buster">BUSTER</option>
                                    <option value="fsp">FSpipeline</option>
                                </select>
                            </td>
                        </tr>
            <tr>
                <th class=" top-options">Refinement mode</th>
                <td class=" top-options">
                    <select class="selectbox" name="refMode">
                        <option disabled selected value> -- select an option -- </option>
                        <option value="refslow">Extra (Slowest)</option>
                        <option value="refslow">Normal (Slow)</option>
                        <option value="reffast">Quick (Fast)</option>
                    </select>
                </td>
            </tr>
            <tr>
                <th class=" top-options">Threshold for MR</th>
                <td class=" top-options">
                    <input class="selectbox" name="mrthresh" placeholder="default: 0.4"></input>
                </td>
            </tr>
            <tr>
                <th class=" top-options">Resolution cutoff</th>
                <td class=" top-options">
                    <input class="selectbox" name="refrescutoff" placeholder="default: None"></input>
                </td>
            </tr>
            <tr>
                <th class=" top-options">PDB model</th>
                <td class=" top-options">
                    <input class="selectbox" name="refrescutoff" placeholder="PDB ID or full path"></input>
                </td>
            </tr>
            <tr class="custompar">
                <th class=" top-options">Custom parameters</th>
                <td class=" top-options"><input class="selectbox" name="customrefine" placeholder="default: None"></input> </td>
            </tr>
            <tr>
                <th></th>
                <td style="padding-top:20px">
                    <input type="button" class="btn btn-right" value="Run refinement"> </input>
                </td>
            </tr>
            </tbody>

            </table>
        </div>

    </div>
</div>


<div class="flex-right">
    <div>
        <div class="card-content card-content-right">
            <div class="card-title">Ligand fitting</div>
            <table class="optionstable">
                <col width="200">
                <col width="450">
                <tbody>
                    <tr>
                        <th class=" top-options">Software</th>
                        <td class=" top-options">
                            <select class="selectbox" name="ligfitSW">
                                <option disabled selected value> -- select an option -- </option>
                                <option value="rhofit">RhoFit</option>
                                <option value="phenixligfit">Phenix LigFit</option>
                            </select>
                        </td>
                    </tr>
        <th class=" top-options">Ligand SMILES</th>
        <td class=" top-options">
            <input class="selectbox" name="ligsmiles" placeholder="CN1C=NC2=C1C(=O)N(C(=O)N2C)C"></input>
        </td>
        <tr>
            <th class=" top-options">Copies to search</th>
            <td class=" top-options">
                <input class="selectbox" name="numberofcopies" placeholder="default: 1"></input>
            </td>
        <tr>
        </tr>
        <tr>
            <th class=" top-options">Fitting process</th>
            <td class=" top-options">
                <select class="selectbox" name="fitprocess">
                    <option disabled selected value> -- select an option -- </option>
                    <option value="ligfitquick">Quick</option>
                    <option value="ligfitthorough">Thorough</option>
                </select>
            </td>
        <tr>
        </tr>
        <tr>
            <th class=" top-options">Scan chirals</th>
            <td class=" top-options">
                <select class="selectbox" name="scanchirals">
                    <option disabled selected value> -- select an option -- </option>
                    <option value="chiralsyes">Yes</option>
                    <option value="chiralsno">No</option>
                </select>
            </td>
        </tr>
        <tr class="custompar">
            <th class=" top-options">Custom parameters</th>
            <td class=" top-options"><input class="selectbox" name="customligfit" placeholder="default: None"></input> </td>
        </tr>
        <tr>
            <th></th>
            <td style="padding-top:20px">

                <input type="button" class="btn btn-right" value="Run ligand fitting"> </input>
            </td>
        </tr>

        </tbody>
        </table>
    </div>
</div>
</div>
<div class="bottom-right">
    <input type="button" class="btn-large maxivorange" value="Run All"> </input>
</div>
</div>
</div>
<div class="flexdiv">
    <div>
        <div class="flexdiv_snapshot">
            <div class="diff1">
                <img class="myImg crystalsnap" id="diff1" src="/static/biomax/20180489/20190127/fragmax/process/hCAII/{{imgprf}}/{{imgprf}}_1_{{imgs}}.jpg">
            </div>
            <div class="diff2">
                <img class="myImg crystalsnap" id="diff2" src="/static/biomax/20180489/20190127/fragmax/process/hCAII/{{imgprf}}/{{imgprf}}_1_1.jpg">
            </div>
        </div>

        <div class="flexdiv_snapshot">
            <div class="snap1">
                <img class="myImg crystalsnap" id="snap1" src="/static/biomax/20180489/20190127/fragmax/process/hCAII/{{imgprf}}/{{imgprf}}_snapshot.jpg" onerror="if (this.src != '/static/img/nosnap.png') this.src='/static/img/nosnap.png';">
                
            </div>
            <div class="snap2">
                <img class="myImg crystalsnap" id="snap2" src="/static/biomax/20180489/20190127/fragmax/process/hCAII/{{imgprf}}/{{imgprf}}_snapshot.jpg" onerror="if (this.src != '/static/img/nosnap.png') this.src='/static/img/nosnap.png';">
            </div>
        </div>
    </div>
    
    <div class="flex-left">
        <div class="card">
            <div class="card-content card-content-left">
                <div class="card-title">Experiment parameters</div>
                <table class="tableInfo">
                    <col width="200">
                    <col width="450">
                    <tbody>
                        <tr>
                            <th>Img directory</th>
                            <td name="imgdirNAME" id="imgdirID">/data/visitors/biomax/20180489/20190127/raw/{{acr}}/{{imgprf}}/</td>
                        </tr>
                        <tr>
                            <th>Img prefix</th>
                            <td>{{acr}}</td>
                        </tr>
                        <tr>
                            <th>Run number</th>
                            <td>{{run}}</td>
                        </tr>
                        <tr>
                            <th># of images</th>
                            <td>{{numberOfImages}}</td>
                        </tr>
                        <tr>
                            <th>Start time</th>
                            <td>{{startTime}} </td>
                        </tr>
                        <tr>
                            <th>End time</th>
                            <td>{{endTime}}</td>
                        </tr>
                        <tr>
                            <th>Type of experiment</th>
                            <td>OSC</td>
                        </tr>
                        <tr>
                            <th>Wavelength</th>
                            <td>{{wavelength}} Å </td>
                        </tr>
                        <tr>
                            <th>Energy</th>
                            <td>{{energy}} keV</td>
                        </tr>
                        <tr>
                            <th>Phi Start</th>
                            <td>{{axisStart}}° </td>
                        </tr>
                        <tr>
                            <th>Oscillation range</th>
                            <td>{{axisRange}}° </td>
                        </tr>
                        <tr>
                            <th>Overlap</th>
                            <td>{{overlap}}° </td>
                        </tr>
                        <tr>
                            <th>Exposure time</th>
                            <td>{{exposureTime}} s </td>
                        </tr>
                        <tr>
                            <th>Total Exposure time</th>
                            <td>{{totalExposure}} s</td>
                        </tr>
                        <tr>
                            <th>Estimated dose</th>
                            <td>Not defined </td>
                        </tr>
                        <tr>
                            <th>Detector distance</th>
                            <td>{{detectorDistance}} mm </td>
                        </tr>
                        <tr>
                            <th>Resolution at edge</th>
                            <td>{{resolution}} Å </td>
                        </tr>
                        <tr>
                            <th>Resolution at corner</th>
                            <td>{{edgeResolution}} Å </td>
                        </tr>
                        <tr>
                            <th>Xbeam</th>
                            <td>{{xbeampos}} mm</td>
                        </tr>
                        <tr>
                            <th>Ybeam</th>
                            <td>{{ybeampos}} mm</td>
                        </tr>
                        <tr>
                            <th>Kappa</th>
                            <td>0 </td>
                        </tr>
                        <tr>
                            <th>Phi</th>
                            <td>0 </td>
                        </tr>

                    </tbody>

                </table>
            </div>

        </div>
    </div>

    <div class="flex-right">
        <div class="card">
            <div class="card-content card-content-right">
                <div class="card-title">Beamline parameters</div>
                <table class="tableInfo">
                    <col width="200">
                    <col width="450">
                    <tbody>
                        <tr>
                            <th>Synchrotron</td>
                            <td>MAX IV Laboratory</td>
                        </tr>
                        <tr>
                            <th>Filling mode</td>
                            <td>{{synchrotronMode}}</td>
                        </tr>

                        <tr>
                            <th>Beamline</td>
                            <td>BioMAX</td>
                        </tr>                        
                        <tr>
                            <th>Detector type</td>
                            <td>Hybrid pixel direct counting device</td>
                        </tr>
                        <tr>
                            <th>Detector model</td>
                            <td>Eiger 16M</td>
                        </tr>
                        <tr>
                            <th>Detector pixel size (HxV)</td>
                            <td>0.075 mm x 0.075 mm</td>
                        </tr>
                        <tr>
                            <th>Focusing optics</td>
                            <td>KB mirrors</td>
                        </tr>
                        <tr>
                            <th>Monochromator type</td>
                            <td>Si(111)</td>
                        </tr>
                        <tr>
                            <th>Beam shape</td>
                            <td>{{beamShape}}</td>
                        </tr>
                        <tr>
                            <th>Beam transmission</td>
                            <td>{{transmission}}%</td>
                        </tr>
                        <tr>
                            <th>Slit gap hor</td>
                            <td>{{slitH}} μm</td>
                        </tr>
                        <tr>
                            <th>Slit gap ver</td>
                            <td>{{slitV}} μm</td>
                        </tr>
                        <tr>
                            <th>Flux (estimated)</td>
                            <td>1.4 10^11 ph/s</td>
                        </tr>
                        <tr>
                            <th>Beam size at sample (HxV)</td>
                            <td>{{beamSizeSampleX}} μm x {{beamSizeSampleY}} μm</td>
                        </tr>
                        <tr>
                            <th>Beam divergence (HxV)</td>
                            <td>6 μrad x 104 μrad</td>
                        </tr>
                        <tr>
                            <th>Polarisation</td>
                            <td>0.99°</td>
                        </tr>
                    </tbody>
                </table>
                <br>
                <div class="card-title">Soaking parameters</div>
                <table class="tableSoak">
                    <col width="320">
                    <col width="300">
                    <col width="450">
                    <tbody>
                        <tr>
                            <th>Soaking time</td>
                            <td>{{soakTime}}</td>
                            <td rowspan="3" ><img class="ligpng" id="ligand" src="/static/blog/fragment/{{ligand}}" onerror="if (this.src != '/static/img/nolig.png') this.src='/static/img/nolig.png';"></td>
                        </tr>
                        <tr>
                            <th>Fragment Concentration</th>
                            <td>{{fragConc}}</td>
                            <td></td>
                        </tr>
                        <tr>
                            <th>DMSO Concentration (final)</th>
                            <td>{{solventConc}}</td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>





            </div>
        </div>
    </div>
</div>

<script>
var f = document.getElementById("procB");
    
    f.onsubmit = function dataproc() {
        var dataprocCommand="";
        var procSW   = document.getElementsByName("procSW")[0].value;
        var SPG      = document.getElementsByName("spacegroup")[0].value;
        var CellPar  = document.getElementsByName("cellparameters")[0].value;
        var Friedel  = document.getElementsByName("friedel")[0].value;
        var DRange   = document.getElementsByName("datarange")[0].value;
        var ResCutoff= document.getElementsByName("rescutoff")[0].value;
        var CCCutoff = document.getElementsByName("cccutoff")[0].value;
        var Isigma   = document.getElementsByName("isigmacutoff")[0].value;
        var custom   = document.getElementsByName("customdataproc")[0].value;
        var imgdir   = document.getElementsByName("imgdirNAME")[0].innerHTML;
        var chdir    = "";
        
        if (procSW == "") {
            return False
        }
        else{
            
            if (Friedel == "") {
                    Friedel = "true"
            }

            //define XDSAPP running command
            if (procSW == "xdsapp") {
                //Set default values for data range if none is provided
                if (DRange == "") {
                    DRange = '1\\ {{numberOfImages}} '
                    }
                else {
                    DRange = DRange.replace("-", "\\ ")
                }

                chdir    = "cd "+imgdir.replace("/raw/","/fragmax/manual_proc/")+"{{imgprf}}_{{run}}/xdsapp #SW=XDSAPP"                
                dataprocCommand = "xdsapp --cmd -j 8 -c 6 -i "+imgdir+"{{imgprf}}_{{run}}_master.h5 --fried="+Friedel+" --range="+DRange+" "+custom
                }

            if (procSW == "dials") {
                //Set default values for data range if none is provided
                if (DRange == "") {
                    DRange = '1:{{numberOfImages}}'
                    }
                else {
                    DRange = DRange.replace("-", ":")
                }
                if (SPG != "") {
                    spginput="space_group="+SPG	
                }    
                else{
                    spginput=""	
                }       
                chdir    = "cd "+imgdir.replace("/raw/","/fragmax/manual_proc/")+"{{imgprf}}_{{run}}/dials #SW=XIA2/DIALS"                
                dataprocCommand = 'xia2 goniometer.axes=0,1,0 pipeline=dials failover=true '+spginput+' nproc=48  image='+imgdir+'{{imgprf}}_{{run}}_master.h5:'+DRange+' multiprocessing.mode=serial  multiprocessing.njob=1  multiprocessing.nproc=auto'+" "+custom
                }

            if (procSW == "xdsxscale") {
                //Set default values for data range if none is provided
                if (DRange == "") {
                    DRange = '1:{{numberOfImages}}'
                    }
                else {
                    DRange = DRange.replace("-", ":")
                }
                chdir    = "cd "+imgdir.replace("/raw/","/fragmax/manual_proc/")+"{{imgprf}}_{{run}}/xia2xds #SW=XIA2/XDS"    
                if (SPG != "") {
                    spginput="space_group="+SPG	
                }    
                else{
                    spginput=""	
                }        
                dataprocCommand = 'xia2 goniometer.axes=0,1,0 pipeline=3dii failover=true '+spginput+' nproc=48  image='+imgdir+'{{imgprf}}_{{run}}_master.h5:'+DRange+' multiprocessing.mode=serial  multiprocessing.njob=1  multiprocessing.nproc=auto'+" "+custom
                } 

            if (procSW == "autoproc") {
                //Set default values for data range if none is provided
                if (DRange == "") {
                    DRange = '1\\ {{numberOfImages}}'
                    }
                else {
                    DRange = DRange.replace("-", "\\ ")
                }
                
                chdir    = "cd "+imgdir.replace("/raw/","/fragmax/manual_proc/")+"{{imgprf}}_{{run}}/autoproc #SW=autoPROC"                
                outdir   = imgdir.replace("/raw/","/fragmax/process/")+"{{imgprf}}_{{run}}/autoproc"
                dataprocCommand = 'process -h5 '+imgdir+'{{imgprf}}_{{run}}_master.h5 -noANO  autoPROC_XdsKeyword_LIB=\\$EBROOTNEGGIA/lib/dectris-neggia.so autoPROC_XdsKeyword_ROTATION_AXIS="0  -1 0" autoPROC_XdsKeyword_MAXIMUM_NUMBER_OF_JOBS=8 autoPROC_XdsKeyword_MAXIMUM_NUMBER_OF_PROCESSORS=6 autoPROC_XdsKeyword_DATA_RANGE='+DRange+' autoPROC_XdsKeyword_SPOT_RANGE='+DRange+' '+custom
                }

            console.log(chdir)
            console.log(dataprocCommand)
            document.getElementsByName("submitProc")[0].value = chdir+";"+dataprocCommand
        }

    }
    // Get the modal
    var modal = document.getElementById('myModal');

    // Get the image and insert it inside the modal - use its "alt" text as a caption
    var img = document.getElementById('diff1');
    var img2 = document.getElementById('diff2');
    var img3 = document.getElementById('snap1');
    var img4 = document.getElementById('snap2');

    var modalImg = document.getElementById("img01");

    img.onclick = function () {
        modal.style.display = "block";
        modalImg.src = this.src;
        captionText.innerHTML = this.alt;
    }
    img2.onclick = function () {
        modal.style.display = "block";
        modalImg.src = this.src;
        captionText.innerHTML = this.alt;
    }
    img3.onclick = function () {
        modal.style.display = "block";
        modalImg.src = this.src;
        captionText.innerHTML = this.alt;
    }
    img4.onclick = function () {
        modal.style.display = "block";
        modalImg.src = this.src;
        captionText.innerHTML = this.alt;
    }
    window.onclick = function (event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
    
</script>
{% endblock %}