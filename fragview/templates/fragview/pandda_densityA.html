{% extends 'fragview/base.html' %}

{% block title %}FragMAX - PanDDA analyses viewer{% endblock %}
{% block content %}

<head>
  <meta name="viewport" content="width=device-width, user-scalable=no">
  <meta name="theme-color" content="#333333">
  <style>
    body {
      font-family: sans-serif;
      overflow: hidden;
    }

    canvas {
      display: block;
      height: 100% !important;
      width: 100% !important;
    }

    .side-table {
      font-size: 15px;
    }

    #viewer {
      position: absolute;
      left: 550px;
      width: calc(100% - 550px);
      height: 100%;
    }

    #help {
      display: none;
      font-size: 16px;
      color: #eee;
      background-color: rgba(0, 0, 0, 0.7);
      position: absolute;
      left: 550px;
      top: 50%;
      transform: translateY(-50%);
      cursor: default;
      padding: 5px;
      border-radius: 5px;
      z-index: 9;
      white-space: pre-line;
    }

    #left-controlpanel {
      font-size: 16px;
      background-color: rgba(0, 0, 0, 0.1);
      position: absolute;
      left: 265px;
      top: 10px;
      height: calc(100% - 20px);
      width: 270px;
      cursor: default;
      padding: 5px;
      border-radius: 5px;
      z-index: 9;
    }

    #hud u {
      text-decoration: none;
      border: solid;
      border-width: 1px 0;
    }

    #hud s {
      padding: 0 8px;
      text-decoration: none;
      opacity: 0.5;
    }

    #inset {
      width: 200px;
      height: 200px;
      background-color: #888;
      position: absolute;
      right: 0;
      bottom: 0;
      z-index: 2;
      display: none;
    }

    a {
      color: #59C;
    }

    #viewer b {
      color: #FCFCFC;
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 22px;
    }

    .svg {
      -webkit-filter: contrast(0.5);
      filter: contrast(0.5);
    }

    .navbt {
      width: 110px;
      font-size: 11px;
    }

    #viewer1 b,
    #viewer2 b {
      color: #FCFCFC;
    }

    #viewer1 b {
      overflow: hidden;
      font-size: 24px;
      position: absolute;
      bottom: 60px;
      left: 50%;
    }

    #viewer2 b {
      overflow: hidden;
      font-size: 24px;
      position: absolute;
      bottom: 60px;
      right: 50%;
    }

    .viewer-dual {
      position: absolute;
      top: 0;
      width: calc((100% - 550px)/2);
      height: 100%;
    }

    .viewer-single {
      position: absolute;
      top: 0;
      width: calc(100% - 550px);
      height: 100%;
    }

    #viewer1 {
      left: 550px;
    }

    #viewer2 {
      right: 0;
    }

    .ligandSVG {

      position: absolute;
      bottom: 10px;
      width: 250px;
    }
  </style>


  <script src="/static/libs/uglymol.js"></script>
  <script src="/static/libs/wasm/mtz.js"></script>

</head>

<body style="background-color: white">
  <div id="left-controlpanel">
    <div style="padding-left:15px !important;">
      <div>
        <h6><a href="/logs/show/{{summary}}" target="_blank">Analysis summary</a></h6>
      </div>

      <div style="display:block; ">
        <input class="btn navbt" type="button" value="Prev site" onclick="return previoussite()"/>
        <input class="btn navbt" type="button" value="Next site" onclick="return nextsite()"/>
      </div>

    </div>
    <div style="padding-top:10px !important;padding-left:15px !important;padding-right:15px !important">
      <table>

        <tr>
          <th>Resolution
          </th>
          <td>{{dataset.resolution}} Ã…
          </td>
        </tr>

        {% if not ground_model %}
        <tr>
          <th>Rwork</th>
          <td>{{dataset.r_work}}</td>
        </tr>
        <tr>
          <th>Rfree
          </th>
          <td>{{dataset.r_free}}
          </td>
        </tr>
        {% endif %}

        <tr>
          <th>Spacegroup
          </th>
          <td>{{dataset.space_group}}
          </td>
        </tr>

        {% if not ground_model %}

        <tr>
          <th>1-BDC</th>
          <td>{{event.bdc}}</td>
        </tr>

        <tr>
          <th>Site</th>
          <td id="tdsite">1</td>
        </tr>
        <tr>
          <th>Event</th>
          <td>{{event.event_idx}}</td>
        </tr>
        {% endif %}
      </table>
    </div>

    <div style="padding-top: 30px; padding-left:15px !important;" hidden>

      <h6>Load dataset or mtz</h6>

      <div style="display:flex">
        <div style="padding-top:10px"><input class="btn-small" type="button" value="Next mdld" disabled></input> </div>
        <div style="padding-top:10px;padding-left:5px"><input class="btn-small" type="button" value="Avg  map"
            disabled></input> </div>
      </div>
      <div style="display:flex">
        <div style="padding-top:10px"><input class="btn-small" type="button" value="Input mtz " disabled></input> </div>
        <div style="padding-top:10px;padding-left:5px"><input class="btn-small" type="button" value="Unfitted"
            disabled></input> </div>
      </div>
    </div>

    <div style="padding-left:15px !important; padding-top:30px !important;" hidden>
      <div class="col s12 required inline" id="event_marker">
        <div class="radio" id="event_mark"><label>
            <input class="with-gap" id="interesting_radio" name="ref_type" type="radio" value="interesting">
            <span class="item-label" for="interesting_radio">Event interesting</span>
          </label></div>

        <div class="radio" id="event_mark"><label>
            <input class="with-gap" id="notinteresting_radio" name="ref_type" type="radio" value="notinteresting">
            <span class="item-label" for="notinteresting_radio">Event not interesting</span>
          </label></div>

      </div>
    </div>

    <div style="padding-left:15px !important; padding-top:60px !important;" hidden>
      <div class="col s12 required inline" id="ligand_modelled">
        <div class="radio" id="ligand_placed"><label>
            <input class="with-gap" id="lig_radio" name="lig_placed" type="radio" value="placed">
            <span class="item-label" for="lig_radio">Ligand placed</span>
          </label></div>

        <div class="radio" id="ligand_placed"><label>
            <input class="with-gap" id="nolig_radio" name="lig_placed" type="radio" value="notplaced">
            <span class="item-label" for="nolig_radio">No ligand placed</span>
          </label></div>

      </div>
    </div>


    <div style="padding-left:15px !important;padding-top:60px !important;" hidden>
      <div class="col s12 required inline" id="model_confidence">
        <div class="radio" id="conf_level"><label>
            <input class="with-gap" id="high_conf_radio" name="model_conf" type="radio" value="high">
            <span class="item-label" for="high_conf_radio">High confidence</span>
          </label></div>

        <div class="radio" id="conf_level"><label>
            <input class="with-gap" id="medium_conf_radio" name="model_conf" type="radio" value="medium">
            <span class="item-label" for="medium_conf_radio">Medium confidence</span>
          </label></div>

        <div class="radio" id="conf_level"><label>
            <input class="with-gap" id="low_conf_radio" name="model_conf" type="radio" value="low">
            <span class="item-label" for="low_conf_radio">Low confidence</span>
          </label></div>
      </div>
    </div>

    <div class="ligandSVG">
      {% if not ground_model %}
      <div>
        <h5 style="text-align: center;">{{fragment.code}}</h5>
      </div>
      <img class="ligpng ligandSVG svg" id="ligand" src="/fragment/{{fragment.id}}/image">
      {% endif %}
    </div>

  </div>


  <div style="display:flex;">
    <div style="z-index:1; color: #FCFCFC; position: absolute; bottom: 20px; left: 600px">
      <b>
        <h6>{{dataset.name}}</h6>
      </b>

      <header id="hud">Automated ligand fit comparison for fragment {{fragment.code}}. Click on the ligand image to center
        view. Press H for help.</header>
    </div>
  </div>

  {% if ground_model %}
  <div id="viewer1" class="viewer-single">
    <b>Dataset used to create Ground State Model<br></b>
  </div>
  {% else %}
    <div id="viewer1" class="viewer-dual"><b>Event map<br></b></div>
    <div id="viewer2" class="viewer-dual"><b>Average map<br></b></div>
  {% endif %}

  <header id="hud"></header>
  <footer id="help"></footer>


  <footer id="help"></footer>
  <div id="inset"></div>

  <script>
    V1 = new UM.Viewer({ viewer: "viewer1", focusable: true, hud: "hud", help: "help" });

    {% if ground_model %}

    V1.load_pdb("/pdbs/pandda/input/{{dataset.name}}/{{method}}");

    GemmiMtz().then(
      function (Module)
      {
        UM.load_maps_from_mtz(Module, V1, "/density_map/pandda/{{dataset.name}}/{{method}}/input");
      });

    {% else %}

    const center = [{{event.x}}, {{event.y}}, {{event.z}}];

    V1.load_pdb_and_ccp4_maps(
      "/pdbs/pandda/input/{{dataset.name}}/{{method}}",
      "/density_map/pandda/{{dataset.name}}/{{method}}/bdc",
      "/density_map/pandda/{{dataset.name}}/{{method}}/zmap");

    V2 = new UM.Viewer({ viewer: "viewer2", focusable: true, share_view: V1, hud: "hud", help: "help" });

    V2.load_pdb(
      "/pdbs/pandda/input/{{dataset.name}}/{{method}}",
      null,
      function ()
      {
        V2.recenter(center, null, 25);
      });

    V2.load_ccp4_maps("/density_map/pandda/{{dataset.name}}/{{method}}/average");
    V1.recenter(center, null, 25)

    {% endif %}

    V1.renderer.domElement.focus();
    V1.change_zoom_by_factor(3.5);

    {% if ground_model %}

    var centroid = {{ centroids }};
    var centroidL = centroid.length
    var sites = centroid;
    var site_idxs = range(1, centroidL);

    {% else %}

    var ligcenter = [{{ center }}]
    var centroid = {{ centroids }};
    var centroidL = centroid.length
    var sites = ligcenter.concat(centroid);
    var site_idxs = [{{ siten }}].concat(range(1, centroidL));
    function centerligand()
    {
      V1.recenter(center, null, 25)
      V1.request_render()
    }
    $(document).ready(function () {
      $(document).bind("keydown", function (e) {
        e = e || window.event;
        var charCode = e.which || e.keyCode;
        if (charCode == 88) centerligand();
      });
    });

    {% endif %}

    var index = 0;
    var numsites = sites.length;

    function nextsite() {
      index = (index + 1) % numsites;
      var site = sites[index];
      movetosite(site)
      document.getElementById("tdsite").innerHTML = site_idxs[index]
    }
    function previoussite() {
      index = (index - 1) % numsites;
      if (index < 0) { index = numsites - 1 }
      var site = sites[index];
      movetosite(site)
      document.getElementById("tdsite").innerHTML = site_idxs[index]
    }
    function movetosite(b) {
      V1.recenter(b, null, 25);
      V1.request_render();
    }
    function range(start, end) {
      /* generate a range : [start, start+1, ..., end-1, end] */
      var len = end - start + 1;
      var a = new Array(len);
      for (let i = 0; i < len; i++) a[i] = start + i;
      return a;
    }
    $(document).ready(function () {
      $(document).bind("keydown", function (e) {
        e = e || window.event;
        var charCode = e.which || e.keyCode;
        if (charCode == 37) previoussite();
      });
    });
    $(document).ready(function () {
      $(document).bind("keydown", function (e) {
        e = e || window.event;
        var charCode = e.which || e.keyCode;
        if (charCode == 39) nextsite();
      });
    });

  </script>
</body>

</html>


{% endblock %}