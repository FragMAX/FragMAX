{% extends 'fragview/base.html' %} {% block title %}FragMAX - Home{% endblock %} {% block content %} {% load static %}

    <style>

    th { cursor: pointer; text-align: center; } td, th { border: 1px solid #f0f0f0; padding: 8px; text-align: center; } tr:nth-child(even) { background-color: #dddddd; height: 150px; } .container { margin: 0 50px 50px 300px !important; max-width: 100% !important;
    width: calc(100% - 350px) !important; } .crystalsnap { max-width: 100%; max-height: 180px; } .ligpng { height:144px; width:144px; } .color-legend { line-height: 0.8 !important; position: absolute; right: 80px; top: 20px; } img { cursor: pointer; }
    /* The Modal (background) */


    </style>

    <style>
        .modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 1;
            /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            max-height: 100% !important;
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgb(0, 0, 0);
            /* Fallback color */
            background-color: rgba(0, 0, 0, 0.3);
            /* Black w/ opacity */
            backdrop-filter: blur(6px);
        }
        /* Modal Content (image) */
        
        .modal-content {
            margin: auto;
            display: flex;
            max-width: 50%;
        }
        /* Add Animation */
        
        .modal-content {
            -webkit-animation-name: zoom;
            -webkit-animation-duration: 0.2s;
            animation-name: zoom;
            animation-duration: 0.2s;
        }
        
        @-webkit-keyframes zoom {
            from {
                -webkit-transform: scale(0)
            }
            to {
                -webkit-transform: scale(1)
            }
        }
        
        @keyframes zoom {
            from {
                transform: scale(0)
            }
            to {
                transform: scale(1)
            }
        }
        /* 100% Image Width on Smaller Screens */
        
        @media only screen and (max-width: 700px) {
            .modal-content {
                width: 100%;
            }
        }

        .success {
            color: #82be00;
        }

        .failure {
            color: #f44336;
        }

        .unknown {
            color: #fdd835;
        }

    </style>
    <div id="myModal" class="modal">
        <img class="modal-content" id="SnapshotModal">
        <img class="modal-content" id="SnapshotModal2">

    </div>
    <div>
        <h4>Data Collection Overview</h4>
        <div style="display:flex;">
            <form action="/datasets/" method="get" id="procButton" style="padding-left:20px; ">
                <button class="btn" type="submit" value="resyncStatus" name="resyncstButton" size="1">Update Project Database</button>
            </form>
        </div>
        <div class="color-legend">
            <p align="left">
                <font size="6" class="success">&#9679;</font>
                <font size="4"> Successful</font>
            </p>
            <p align="left">
                <font size="6" class="unknown">&#9679;</font>
                <font size="4"> Not started</font>
            </p>
            <p align="left">
                <font size="6" class="failure">&#9679;</font>
                <font size="4"> Failed</font>
            </p>
        </div>
    </div>
    <p></p>

    <div class="input-field col s12" id="searchDiv">
        <i class="material-icons prefix">search</i>
        <input type="text" id="searchSample" onkeyup="searchSampleName()" title="Type in a sample name">
        <label for="searchSample">Search for Sample names..</label>
    </div>

    <table id="datasetTable">
        <thead>
            <tr>
                <th>Info/Process</th>
                <th>Protein</th>
                <th>Sample name</th>
                <th>Run</th>

                <th>Proc Status</th>
                <th>Ref Status</th>
                <th>Lig Status</th>

                <th>Resolution</sub> [&Aring;]</th>
                <th>Frames</th>
                <th>Crystal Picture</th>
                <th>Ligand</th>

            </tr>
        </thead>
        <tbody>

            <tr>
            </tr>

            {% for dataset in datasets  %}
            <tr>
                <td>
                    <form action="/dataset_info/" method="get">
                        <button class="btn" type="submit"
                                value={{dataset.image_prefix}};{{dataset.num_images}};{{dataset.run}}
                                name="proteinPrefix" size="1">Info</button>
                    </form>
                </td>

                <td>
                    <p>{{dataset.acronym}}</p>
                </td>
                <td>
                    <p>{{dataset.sample_name}}</p>
                </td>
                <td>
                    <p>{{dataset.run}}</p></td>
                <td>
                    <p align="left" style="white-space: nowrap;">
                        <font size="4" class="{{dataset.status.auto_proc}}">&#9679;</font>
                        <font size="2">autoPROC</font>
                    </p>

                    <p align="left" style="white-space: nowrap;">
                        <font size="4" class="{{dataset.status.xia2_dials}}">&#9679;</font>
                        <font size="2">XIA2/DIALS</font>
                    </p>

                    <p align="left" style="white-space: nowrap;">
                        <font size="4" class="{{dataset.status.edna_proc}}">&#9679;</font>
                        <font size="2">EDNA_proc</font>
                    </p>

                    <p align="left" style="white-space: nowrap;">
                        <font size="4" class="{{dataset.status.fastdp}}">&#9679;</font>
                        <font size="2">fastdp</font>
                    </p>

                    <p align="left" style="white-space: nowrap;">
                        <font size="4" class="{{dataset.status.xdsapp}}">&#9679;</font>
                        <font size="2">XDSAPP</font>
                    </p>

                    <p align="left" style="white-space: nowrap;">
                        <font size="4" class="{{dataset.status.xia2_xds}}">&#9679;</font>
                        <font size="2">XIA2/XDS</font>
                    </p>

                    <p align="left" style="white-space: nowrap;">
                        <font size="4" class="{{dataset.status.pipedream_proc}}">&#9679;</font>
                        <font size="2">Pipedream</font>
                    </p>
                </td>

                <td>
                    <p align="left" style="white-space: nowrap;">
                        <font size="4" class="{{dataset.status.buster}}">&#9679;</font>
                        <font size="2">BUSTER</font>
                    </p>

                    <p align="left" style="white-space: nowrap;">
                        <font size="4" class="{{dataset.status.dimple}}">&#9679;</font>
                        <font size="2">DIMPLE</font>
                    </p>

                    <p align="left" style="white-space: nowrap;">
                        <font size="4" class="{{dataset.status.fspipeline}}">&#9679;</font>
                        <font size="2">fspipeline</font>
                    </p>

                    <p align="left" style="white-space: nowrap;">
                        <font size="4" class="{{dataset.status.pipedream_refine}}">&#9679;</font>
                        <font size="2">Pipedream</font>
                    </p>
                </td>

                <td>
                    <p align="left" style="white-space: nowrap;">
                        <font size="4" class="{{dataset.status.ligand_fit}}">&#9679;</font>
                        <font size="2">LigandFit</font>
                    </p>

                    <p align="left" style="white-space: nowrap;">
                        <font size="4" class="{{dataset.status.rho_fit}}">&#9679;</font>
                        <font size="2">RhoFit</font>
                    </p>

                    <p align="left" style="white-space: nowrap;">
                        <font size="4" class="{{dataset.status.pipedream_ligand}}">&#9679;</font>
                        <font size="2">Pipedream</font>
                    </p>
                </td>

                <td>
                    <p>{{dataset.resolution}}</p>
                </td>
                <td>
                  <p>{{dataset.num_images}}</p>
                </td>

                <td>
                    {% if dataset.snapshots.0 %}
                        <img class="crystalsnap"
                             id="snap0-{{dataset.sample_name}}_{{dataset.run}}"
                             src={% static dataset.snapshots.0 %}
                             onerror="if (this.src != '') this.src='';"
                             onclick="show_snapshots('{{dataset.sample_name}}_{{dataset.run}}');">
                    {% endif %}

                    {% if dataset.snapshots.1 %}
                        <img class="crystalsnap"
                             id="snap1-{{dataset.sample_name}}_{{dataset.run}}"
                             src={% static dataset.snapshots.1 %}
                             onerror="if (this.src != '') this.src='';"
                             onclick="show_snapshots('{{dataset.sample_name}}_{{dataset.run}}');">
                    {% endif %}
                </td>

                <td>
                    {% if dataset.is_apo is not True %}
                        <a href="/fragment/{{dataset.sample_name}}/image" target="_blank">
                            <img class="ligpng" src="/fragment/{{dataset.sample_name}}/image">
                        </a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>


    </tbody>

    </table>
    <script>
      const getCellValue = (tr, idx) => tr.children[idx].innerText || tr.children[idx].textContent;
      const comparer = (idx, asc) => (a, b) => ((v1, v2) =>
          v1 !== '' && v2 !== '' && !isNaN(v1) && !isNaN(v2) ? v1 - v2 : v1.toString().localeCompare(v2)
          )(getCellValue(asc ? a : b, idx), getCellValue(asc ? b : a, idx));
      
      // do the work...
      document.querySelectorAll('th').forEach(th => th.addEventListener('click', (() => {
          const table = th.closest('table');
          Array.from(table.querySelectorAll('tr:nth-child(n+2)'))
              .sort(comparer(Array.from(th.parentNode.children).indexOf(th), this.asc = !this.asc))
              .forEach(tr => table.appendChild(tr) );
      })));
      function searchSampleName() {
              var input, filter, table, tr, td, i, txtValue;
              input = document.getElementById("searchSample");
              filter = input.value.toUpperCase();
              table = document.getElementById("datasetTable");
              tr = table.getElementsByTagName("tr");
              for (i = 0; i < tr.length; i++) {
                  td = tr[i].getElementsByTagName("td")[2];
                  if (td) {
                  txtValue = td.textContent || td.innerText;
                  if (txtValue.toUpperCase().indexOf(filter) > -1) {
                      tr[i].style.display = "";
                  } else {
                      tr[i].style.display = "none";
                  }
                  }
              }
              }
      
      var modal = document.getElementById("myModal");
      var modalImg = document.getElementById("SnapshotModal");
      var modalImg2 = document.getElementById("SnapshotModal2");
      
      function show_snapshots(msg) {
          /* get the image and insert it inside the modal */
          modal.style.display = "flex";

          modalImg.src = document.getElementById("snap0-"+msg).src;
          modalImg2.src = document.getElementById("snap1-"+msg).src;
      }

      // Get the <span> element that closes the modal
      var span = document.getElementsByClassName("close")[0];
      
      // When the user clicks on <span> (x), close the modal
      
          window.onclick = function (event) {
                  if (event.target == modal) {
                      modal.style.display = "none";
                  }
              }
          $(document).ready(function(){
              $(document).bind("keydown", function(e){
                  e = e || window.event;
                  var charCode = e.which || e.keyCode;
                  if(charCode == 27) {
                      modal.style.display = "none";
                  };
              });
          });
      </script>

    {% endblock %}